# å°çº¢ä¹¦æ–‡æ¡ˆç”Ÿæˆæ™ºèƒ½ä½“ API æ–‡æ¡£

## æ¦‚è¿°

å°çº¢ä¹¦æ–‡æ¡ˆç”Ÿæˆæ™ºèƒ½ä½“ API æ˜¯ä¸€ä¸ªåŸºäºå¤§è¯­è¨€æ¨¡å‹çš„æ™ºèƒ½æ–‡æ¡ˆç”ŸæˆæœåŠ¡ï¼Œæä¾›å®Œæ•´çš„æ–‡æ¡ˆåˆ›ä½œã€ä¼˜åŒ–å’Œå¯¹è¯åŠŸèƒ½ã€‚

### æŠ€æœ¯ç‰¹è‰²
- ğŸ¯ **æ™ºèƒ½æ–‡æ¡ˆç”Ÿæˆ**: æ ¹æ®ä¸»é¢˜å’Œé£æ ¼è¦æ±‚ç”Ÿæˆé«˜è´¨é‡å°çº¢ä¹¦æ–‡æ¡ˆ
- ğŸ”„ **å†…å®¹ä¼˜åŒ–**: å¯¹ç°æœ‰æ–‡æ¡ˆè¿›è¡Œæ™ºèƒ½ä¼˜åŒ–å’Œæ”¹è¿›
- ğŸ’¬ **å¯¹è¯èŠå¤©**: ä¸AIåŠ©æ‰‹è¿›è¡Œè‡ªç„¶å¯¹è¯äº¤æµ
- ğŸ“ **åé¦ˆå›ç¯**: åŸºäºç”¨æˆ·åé¦ˆæŒç»­æ”¹è¿›ç”Ÿæˆè´¨é‡
- ğŸ“š **ç‰ˆæœ¬ç®¡ç†**: æ”¯æŒå¤šç‰ˆæœ¬å†…å®¹ç®¡ç†å’Œå†å²è®°å½•
- ğŸ”„ **å®æ—¶æµå¼**: æ”¯æŒSSEå®æ—¶æµå¼è¾“å‡º

## å¿«é€Ÿå¼€å§‹

### 1. å¯åŠ¨æœåŠ¡

```bash
# å¯åŠ¨FastAPIæœåŠ¡
python fastapi_server.py

# æˆ–ä½¿ç”¨uvicorn
uvicorn fastapi_server:app --host 0.0.0.0 --port 8000 --reload
```

### 2. è®¿é—®æ–‡æ¡£

- **Swagger UI**: http://localhost:8000/docs
- **ReDoc**: http://localhost:8000/redoc
- **OpenAPI JSON**: http://localhost:8000/openapi.json

### 3. åŸºç¡€å¥åº·æ£€æŸ¥

```bash
curl http://localhost:8000/health
```

## API ç«¯ç‚¹è¯¦è§£

### åŸºç¡€ä¿¡æ¯

#### GET / - APIåŸºæœ¬ä¿¡æ¯
è·å–APIçš„åŸºæœ¬ä¿¡æ¯ã€çŠ¶æ€å’Œå¯ç”¨ç«¯ç‚¹åˆ—è¡¨ã€‚

#### GET /health - å¥åº·æ£€æŸ¥
æ£€æŸ¥APIæœåŠ¡å’Œæ™ºèƒ½ä½“çš„è¿è¡ŒçŠ¶æ€ã€‚

### å†…å®¹ç”Ÿæˆ

#### POST /generate - ç”Ÿæˆå°çº¢ä¹¦æ–‡æ¡ˆ
æ ¹æ®æŒ‡å®šçš„åˆ†ç±»ã€ä¸»é¢˜ã€è¯­è°ƒç­‰å‚æ•°ç”Ÿæˆå°çº¢ä¹¦æ–‡æ¡ˆå†…å®¹ã€‚

**è¯·æ±‚å‚æ•°è¯¦è§£:**
- `category`: å†…å®¹åˆ†ç±»ï¼ˆç¾å¦†æŠ¤è‚¤ã€æ—¶å°šç©¿æ­ã€ç¾é£Ÿæ¢åº—ç­‰ï¼‰
- `topic`: å…·ä½“ä¸»é¢˜æè¿°
- `tone`: è¯­è°ƒé£æ ¼ï¼ˆæ´»æ³¼å¯çˆ±ã€æ¸©é¦¨æ²»æ„ˆã€ä¸“ä¸šè¯¦ç»†ã€å¹½é»˜æç¬‘ã€ç®€æ´æ˜äº†ï¼‰
- `length`: å†…å®¹é•¿åº¦ï¼ˆçŸ­ã€ä¸­ç­‰ã€é•¿ï¼‰
- `keywords`: å…³é”®è¯åˆ—è¡¨ï¼ˆå¯é€‰ï¼‰
- `target_audience`: ç›®æ ‡å—ä¼—
- `special_requirements`: ç‰¹æ®Šè¦æ±‚
- `user_id`: ç”¨æˆ·ID

**ç¤ºä¾‹è¯·æ±‚:**
```json
{
  "category": "ç¾é£Ÿæ¢åº—",
  "topic": "æ–°å¼€çš„æ—¥å¼æ–™ç†åº—åˆä½“éªŒ",
  "tone": "æ´»æ³¼å¯çˆ±",
  "length": "ä¸­ç­‰",
  "keywords": ["æ—¥å¼æ–™ç†", "æ–°åº—", "ç¾å‘³", "æ€§ä»·æ¯”"],
  "target_audience": "å¹´è½»å¥³æ€§",
  "special_requirements": "è¦æœ‰ä¸ªäººä½“éªŒæ„Ÿï¼Œé€‚åˆæ‹ç…§æ‰“å¡",
  "user_id": "user_001"
}
```

#### POST /generate/stream - æµå¼ç”Ÿæˆå°çº¢ä¹¦æ–‡æ¡ˆ
ä½¿ç”¨Server-Sent Eventså®æ—¶æµå¼ç”Ÿæˆå°çº¢ä¹¦æ–‡æ¡ˆï¼Œæ”¯æŒå®æ—¶æŸ¥çœ‹ç”Ÿæˆè¿›åº¦ã€‚

### å†…å®¹ä¼˜åŒ–

#### POST /optimize - ä¼˜åŒ–æ–‡æ¡ˆå†…å®¹
å¯¹ç°æœ‰æ–‡æ¡ˆå†…å®¹è¿›è¡Œæ™ºèƒ½ä¼˜åŒ–ï¼Œæ”¹è¿›è¯­è¨€è¡¨è¾¾å’Œç»“æ„ã€‚

#### POST /optimize/stream - æµå¼ä¼˜åŒ–æ–‡æ¡ˆå†…å®¹
ä½¿ç”¨Server-Sent Eventså®æ—¶æµå¼ä¼˜åŒ–æ–‡æ¡ˆå†…å®¹ã€‚

### å¯¹è¯èŠå¤©

#### POST /chat - å¯¹è¯èŠå¤©
ä¸AIæ™ºèƒ½ä½“è¿›è¡Œè‡ªç„¶è¯­è¨€å¯¹è¯äº¤æµã€‚

#### POST /chat/stream - æµå¼å¯¹è¯èŠå¤©
ä½¿ç”¨Server-Sent Eventsè¿›è¡Œå®æ—¶æµå¼å¯¹è¯èŠå¤©ã€‚

### æ™ºèƒ½åé¦ˆ

#### POST /feedback - æ™ºèƒ½åé¦ˆå¤„ç†
åŸºäºç”¨æˆ·åé¦ˆå¯¹å†…å®¹è¿›è¡Œé‡æ–°ç”Ÿæˆæˆ–ä¼˜åŒ–å¤„ç†ã€‚

**åé¦ˆç±»å‹:**
- `ä¸æ»¡æ„`: å®Œå…¨é‡æ–°ç”Ÿæˆæ–°çš„æ–‡æ¡ˆ
- `æ»¡æ„`: åœ¨å½“å‰åŸºç¡€ä¸Šè¿›è¡Œä¼˜åŒ–
- `éœ€è¦ä¼˜åŒ–`: ä¿æŒä¸»ä½“å†…å®¹ï¼Œè¿›è¡Œç»†èŠ‚ä¼˜åŒ–
- `å®Œå…¨æ»¡æ„`: ç»“æŸå¤„ç†æµç¨‹

#### POST /feedback/stream - æµå¼æ™ºèƒ½åé¦ˆå¤„ç†
ä½¿ç”¨Server-Sent Eventsè¿›è¡Œå®æ—¶æµå¼åé¦ˆå¤„ç†ã€‚

### ç‰ˆæœ¬ç®¡ç†

#### GET /history/{user_id} - è·å–ç‰ˆæœ¬å†å²
è·å–æŒ‡å®šç”¨æˆ·çš„å†…å®¹ç‰ˆæœ¬å†å²è®°å½•ã€‚

#### POST /history/restore - æ¢å¤æŒ‡å®šç‰ˆæœ¬
å°†ç”¨æˆ·å†…å®¹æ¢å¤åˆ°æŒ‡å®šçš„å†å²ç‰ˆæœ¬ã€‚

#### DELETE /history/{user_id} - æ¸…ç©ºç”¨æˆ·å†å²
æ¸…ç©ºæŒ‡å®šç”¨æˆ·çš„æ‰€æœ‰å†å²è®°å½•å’Œç‰ˆæœ¬æ•°æ®ã€‚

### SSEè¿æ¥ç®¡ç†

#### POST /sse/connect - åˆ›å»ºSSEè¿æ¥
åˆ›å»ºServer-Sent Eventsè¿æ¥ç”¨äºå®æ—¶æ¶ˆæ¯æ¨é€ã€‚

#### GET /sse/status/{user_id} - è·å–SSEè¿æ¥çŠ¶æ€
è·å–æŒ‡å®šç”¨æˆ·çš„Server-Sent Eventsè¿æ¥çŠ¶æ€ä¿¡æ¯ã€‚

## Server-Sent Events (SSE) è¯¦è§£

### SSEæ¶ˆæ¯æ ¼å¼

æ‰€æœ‰SSEæ¶ˆæ¯éƒ½éµå¾ªä»¥ä¸‹æ ‡å‡†æ ¼å¼ï¼š

```
event: [äº‹ä»¶ç±»å‹]
data: {JSONæ ¼å¼çš„æ¶ˆæ¯æ•°æ®}

```

### æ¶ˆæ¯ç±»å‹

#### 1. å†…å®¹å—æ¶ˆæ¯ (chunk)
```
event: chunk
data: {
data:   "type": "chunk",
data:   "chunk": "å§å¦¹ä»¬ï¼ä»Šå¤©å‘ç°äº†ä¸€å®¶",
data:   "chunk_type": "content",
data:   "timestamp": "2024-01-15T10:30:00.123Z",
data:   "action": "åˆå§‹ç”Ÿæˆ",
data:   "chunk_count": 1,
data:   "total_length": 12
data: }
```

#### 2. å®Œæˆæ¶ˆæ¯ (complete)
```
event: complete
data: {
data:   "type": "complete",
data:   "content": "å®Œæ•´çš„ç”Ÿæˆå†…å®¹...",
data:   "action": "åˆå§‹ç”Ÿæˆ",
data:   "version": 1,
data:   "total_chunks": 25,
data:   "total_length": 380,
data:   "timestamp": "2024-01-15T10:30:05.456Z"
data: }
```

#### 3. é”™è¯¯æ¶ˆæ¯ (error)
```
event: error
data: {
data:   "type": "error",
data:   "message": "ç”Ÿæˆè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯",
data:   "code": "GENERATION_ERROR",
data:   "timestamp": "2024-01-15T10:30:02.789Z"
data: }
```

#### 4. çŠ¶æ€æ¶ˆæ¯ (status)
```
event: status
data: {
data:   "type": "status",
data:   "status": "started",
data:   "message": "å¼€å§‹ç”Ÿæˆ...",
data:   "progress": 0.1,
data:   "timestamp": "2024-01-15T10:30:00.000Z"
data: }
```

#### 5. å¿ƒè·³æ¶ˆæ¯ (heartbeat)
```
event: heartbeat
data: {
data:   "type": "heartbeat",
data:   "timestamp": "2024-01-15T10:30:00.000Z"
data: }
```

### å®¢æˆ·ç«¯è¿æ¥ç¤ºä¾‹

#### JavaScript
```javascript
const eventSource = new EventSource('http://localhost:8000/sse/connect', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
  },
  body: JSON.stringify({
    user_id: 'user_001',
    connection_type: 'general'
  })
});

eventSource.onmessage = function(event) {
  const data = JSON.parse(event.data);
  console.log('Received:', data);
};

eventSource.addEventListener('chunk', function(event) {
  const data = JSON.parse(event.data);
  console.log('Content chunk:', data.chunk);
});

eventSource.addEventListener('complete', function(event) {
  const data = JSON.parse(event.data);
  console.log('Generation complete:', data.content);
});

eventSource.addEventListener('error', function(event) {
  const data = JSON.parse(event.data);
  console.error('Error:', data.message);
});
```

#### Python
```python
import requests
import json

def handle_sse_stream(user_id):
    url = 'http://localhost:8000/generate/stream'
    data = {
        "category": "ç¾é£Ÿæ¢åº—",
        "topic": "æ–°å¼€çš„æ—¥å¼æ–™ç†åº—åˆä½“éªŒ",
        "tone": "æ´»æ³¼å¯çˆ±",
        "length": "ä¸­ç­‰",
        "user_id": user_id
    }
    
    response = requests.post(url, json=data, stream=True)
    
    for line in response.iter_lines():
        if line:
            line_str = line.decode('utf-8')
            if line_str.startswith('data: '):
                try:
                    data = json.loads(line_str[6:])
                    if data.get('type') == 'chunk':
                        print(data['chunk'], end='', flush=True)
                    elif data.get('type') == 'complete':
                        print(f"\n\nç”Ÿæˆå®Œæˆï¼ç‰ˆæœ¬: {data.get('version')}")
                        break
                except json.JSONDecodeError:
                    continue
```

## é”™è¯¯å¤„ç†

### HTTPçŠ¶æ€ç 

- `200` - è¯·æ±‚æˆåŠŸ
- `400` - è¯·æ±‚å‚æ•°é”™è¯¯
- `500` - æœåŠ¡å™¨å†…éƒ¨é”™è¯¯
- `503` - æœåŠ¡ä¸å¯ç”¨ï¼ˆæ™ºèƒ½ä½“æœªåˆå§‹åŒ–ï¼‰

### é”™è¯¯å“åº”æ ¼å¼

```json
{
  "success": false,
  "message": "é”™è¯¯æè¿°",
  "data": null,
  "timestamp": "2024-01-15T10:30:00"
}
```

## ä½¿ç”¨å»ºè®®

### 1. å†…å®¹åˆ†ç±»é€‰æ‹©
æ ¹æ®æ‚¨çš„å†…å®¹ç±»å‹é€‰æ‹©åˆé€‚çš„åˆ†ç±»ï¼š
- **ç¾å¦†æŠ¤è‚¤**: æŠ¤è‚¤å“è¯„æµ‹ã€åŒ–å¦†æ•™ç¨‹
- **æ—¶å°šç©¿æ­**: æœè£…æ­é…ã€æ—¶å°šè¶‹åŠ¿
- **ç¾é£Ÿæ¢åº—**: é¤å…è¯„ä»·ã€ç¾é£Ÿæ¨è
- **æ—…è¡Œæ”»ç•¥**: æ—…æ¸¸æŒ‡å—ã€æ™¯ç‚¹ä»‹ç»
- **ç”Ÿæ´»æ–¹å¼**: æ—¥å¸¸åˆ†äº«ã€ç”Ÿæ´»çªé—¨

### 2. è¯­è°ƒé£æ ¼é€‰æ‹©
- **æ´»æ³¼å¯çˆ±**: é€‚åˆå¹´è½»å—ä¼—ï¼Œemojiä¸°å¯Œï¼Œäº’åŠ¨æ€§å¼º
- **æ¸©é¦¨æ²»æ„ˆ**: é€‚åˆæƒ…æ„Ÿç±»å†…å®¹ï¼Œæ¸©æš–èˆ’ç¼“
- **ä¸“ä¸šè¯¦ç»†**: é€‚åˆè¯„æµ‹ç±»å†…å®¹ï¼Œå®¢è§‚ä¸“ä¸š
- **å¹½é»˜æç¬‘**: é€‚åˆå¨±ä¹ç±»å†…å®¹ï¼Œè½»æ¾æœ‰è¶£
- **ç®€æ´æ˜äº†**: é€‚åˆä¿¡æ¯ç±»å†…å®¹ï¼Œç›´æ¥ç®€ç»ƒ

### 3. é•¿åº¦é€‰æ‹©
- **çŸ­** (100-200å­—): é€‚åˆç®€å•æ¨èã€æœ‹å‹åœˆåˆ†äº«
- **ä¸­ç­‰** (200-500å­—): é€‚åˆæ ‡å‡†å°çº¢ä¹¦ç¬”è®°
- **é•¿** (500-800å­—): é€‚åˆæ·±åº¦æµ‹è¯„ã€è¯¦ç»†æ”»ç•¥

### 4. åé¦ˆä¼˜åŒ–æµç¨‹
1. ç”Ÿæˆåˆå§‹å†…å®¹
2. æ ¹æ®è´¨é‡ç»™å‡ºåé¦ˆï¼ˆæ»¡æ„/ä¸æ»¡æ„/éœ€è¦ä¼˜åŒ–ï¼‰
3. ç³»ç»Ÿæ ¹æ®åé¦ˆè¿›è¡Œç›¸åº”å¤„ç†
4. é‡å¤æ­¥éª¤2-3ç›´åˆ°æ»¡æ„

### 5. ç‰ˆæœ¬ç®¡ç†æœ€ä½³å®è·µ
- å®šæœŸæŸ¥çœ‹å†å²ç‰ˆæœ¬
- ä¿å­˜æ»¡æ„çš„ç‰ˆæœ¬ä½œä¸ºåŸºå‡†
- åˆ©ç”¨ç‰ˆæœ¬å¯¹æ¯”åŠŸèƒ½é€‰æ‹©æœ€ä½³å†…å®¹

## æ€§èƒ½å’Œé™åˆ¶

### è¿æ¥é™åˆ¶
- æ¯ä¸ªç”¨æˆ·æœ€å¤šå¯åŒæ—¶ç»´æŒ5ä¸ªSSEè¿æ¥
- è¿æ¥è¶…æ—¶æ—¶é—´ï¼š60ç§’æ— æ´»åŠ¨è‡ªåŠ¨æ–­å¼€
- å¿ƒè·³é—´éš”ï¼š30ç§’

### å†…å®¹é™åˆ¶
- å•æ¬¡ç”Ÿæˆå†…å®¹æœ€å¤§é•¿åº¦ï¼š2000å­—
- å…³é”®è¯åˆ—è¡¨æœ€å¤šï¼š20ä¸ª
- å†å²ç‰ˆæœ¬ä¿å­˜ï¼šæ¯ç”¨æˆ·æœ€å¤š50ä¸ªç‰ˆæœ¬

### é€Ÿç‡é™åˆ¶
- å†…å®¹ç”Ÿæˆï¼šæ¯åˆ†é’Ÿæœ€å¤š10æ¬¡è¯·æ±‚
- å¯¹è¯èŠå¤©ï¼šæ¯åˆ†é’Ÿæœ€å¤š20æ¬¡è¯·æ±‚
- å…¶ä»–æ¥å£ï¼šæ¯åˆ†é’Ÿæœ€å¤š50æ¬¡è¯·æ±‚

## å¸¸è§é—®é¢˜ (FAQ)

### Q: å¦‚ä½•è·å¾—æ›´å¥½çš„ç”Ÿæˆæ•ˆæœï¼Ÿ
A: 
1. æä¾›è¯¦ç»†å…·ä½“çš„ä¸»é¢˜æè¿°
2. é€‰æ‹©åˆé€‚çš„è¯­è°ƒå’Œç›®æ ‡å—ä¼—
3. æ·»åŠ ç›¸å…³å…³é”®è¯
4. åœ¨ç‰¹æ®Šè¦æ±‚ä¸­è¯´æ˜å…·ä½“éœ€æ±‚

### Q: SSEè¿æ¥æ–­å¼€äº†æ€ä¹ˆåŠï¼Ÿ
A: 
1. æ£€æŸ¥ç½‘ç»œè¿æ¥
2. é‡æ–°åˆ›å»ºSSEè¿æ¥
3. ç¡®è®¤ç”¨æˆ·IDæ­£ç¡®

### Q: ç”Ÿæˆçš„å†…å®¹ä¸æ»¡æ„æ€ä¹ˆåŠï¼Ÿ
A: 
1. ä½¿ç”¨åé¦ˆæ¥å£ï¼Œé€‰æ‹©"ä¸æ»¡æ„"é‡æ–°ç”Ÿæˆ
2. è°ƒæ•´åŸå§‹å‚æ•°ï¼ˆè¯­è°ƒã€é•¿åº¦ã€ç‰¹æ®Šè¦æ±‚ç­‰ï¼‰
3. ä½¿ç”¨ä¼˜åŒ–æ¥å£è¿›è¡Œæ”¹è¿›

### Q: å¦‚ä½•ç®¡ç†å¤šä¸ªç‰ˆæœ¬ï¼Ÿ
A: 
1. ä½¿ç”¨ `/history/{user_id}` æŸ¥çœ‹æ‰€æœ‰ç‰ˆæœ¬
2. ä½¿ç”¨ `/history/restore` æ¢å¤åˆ°æŒ‡å®šç‰ˆæœ¬
3. å®šæœŸæ¸…ç†ä¸éœ€è¦çš„å†å²è®°å½•

## æŠ€æœ¯æ”¯æŒ

å¦‚æœæ‚¨åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼Œè¯·ï¼š

1. æŸ¥çœ‹æœ¬æ–‡æ¡£çš„å¸¸è§é—®é¢˜éƒ¨åˆ†
2. æ£€æŸ¥ `/health` ç«¯ç‚¹ç¡®è®¤æœåŠ¡çŠ¶æ€
3. æŸ¥çœ‹è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯å’Œæ—¥å¿—
4. è”ç³»æŠ€æœ¯æ”¯æŒå›¢é˜Ÿ

---

*æœ€åæ›´æ–°æ—¶é—´: 2024-01-15*
*APIç‰ˆæœ¬: v1.0.0* 